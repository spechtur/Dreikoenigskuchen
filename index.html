<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digitaler Dreik√∂nigskuchen - PHGR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        // Supabase Config
        const SUPABASE_URL = 'https://hazjcbrsozvgfuyxsugn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhempjYnJzb3p2Z2Z1eXhzdWduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyNTI1MjAsImV4cCI6MjA4MjgyODUyMH0.5L1FbkUC04Jdx6Syx1iI4wfUKDeA6H1wqLRf1xawgzY';

        const DISCUSSION_PROMPTS = [
            "Als Schulleitung frage ich mich, wie wir KI so einsetzen k√∂nnen, dass...",
            "Eine zentrale Herausforderung bei der Digitalit√§t in Schulen sehe ich darin, dass...",
            "Digitale Souver√§nit√§t f√ºr Lehrpersonen bedeutet f√ºr mich...",
            "Wenn ich an KI-robuste Aufgaben denke, dann...",
            "Der gr√∂√üte Unterschied zwischen Digitalisierung und Digitalit√§t ist...",
            "In einer Kultur der Digitalit√§t sollte Schulleitung vor allem...",
            "Wenn Sch√ºler*innen KI nutzen, m√ºssen wir als Schule...",
            "Die Rolle von Lehrpersonen ver√§ndert sich durch KI, indem...",
            "F√ºr eine erfolgreiche digitale Transformation brauchen Schulen...",
            "Bei der Einf√ºhrung von KI-Tools in Schulen stolpern wir oft √ºber...",
            "Eltern haben bez√ºglich KI in der Schule oft die Sorge, dass...",
            "Ein Missverst√§ndnis √ºber Digitalit√§t in Bildung ist...",
            "Wenn wir √ºber digitale Kompetenzen sprechen, vergessen wir oft...",
            "Die gr√∂√üte Chance von KI f√ºr individualisiertes Lernen liegt darin, dass...",
            "Als systemische Br√ºckenbauer*innen zwischen P√§dagogik und Technologie m√ºssen wir...",
            "Datenschutz und p√§dagogische Innovation stehen im Spannungsfeld von...",
            "Wenn Lehrpersonen KI ablehnen, liegt das h√§ufig daran, dass...",
            "Eine Schule, die Digitalit√§t wirklich versteht, zeichnet sich dadurch aus, dass...",
            "Der Unterschied zwischen KI nutzen und KI verstehen ist...",
            "F√ºr authentisches Lernen in einer digitalisierten Welt braucht es...",
            "Open Source statt Cloud-Dienste bedeutet f√ºr Schulen...",
            "Wenn ich die Pippi-Langstrumpf-Philosophie auf digitale Schulentwicklung √ºbertrage, dann...",
            "KI-Literacy f√ºr Sch√ºler*innen hei√üt konkret...",
            "Das gr√∂√üte Hindernis f√ºr digitale Innovation in Schulen ist...",
            "Wenn wir Lehrplan 21 und KI zusammendenken, dann...",
            "Eine Kultur der Digitalit√§t entsteht in Schulen, wenn...",
            "Die Balance zwischen Bewahrung und Wandel finden wir, indem...",
            "Kompetenzorientierung im Zeitalter von KI bedeutet...",
            "Als Schulleitung kann ich Lehrpersonen beim digitalen Wandel unterst√ºtzen durch...",
            "Der wichtigste Grundsatz f√ºr den Umgang mit KI in Schulen sollte sein..."
        ];

        const KING_TASK = "üëë Du bist heute K√∂nig*in! Deine Aufgabe: Achte den ganzen Tag darauf, wann wir √ºber Digitalit√§t sprechen, aber eigentlich nur Digitalisierung meinen - und weise uns freundlich darauf hin!";

        // State
        let state = {
            connected: false,
            loading: true,
            setupComplete: false,
            totalPieces: 25,
            gameState: null,
            selectedPiece: null,
            pollInterval: null
        };

        // Supabase API
        async function fetchState() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/kuchen_state?id=eq.current&select=data`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch');

                const data = await response.json();
                if (data[0]?.data && Object.keys(data[0].data).length > 0) {
                    state.gameState = data[0].data;
                    state.setupComplete = data[0].data.started || false;
                }
                state.connected = true;
                render();
            } catch (error) {
                console.error('Error:', error);
                state.connected = false;
                render();
            }
        }

        async function updateState(newState) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/kuchen_state?id=eq.current`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}',
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        data: newState,
                        updated_at: new Date().toISOString()
                    })
                });

                if (!response.ok) throw new Error('Failed to update');
                return true;
            } catch (error) {
                console.error('Error:', error);
                return false;
            }
        }

        // Actions
        async function startGame() {
            state.loading = true;
            render();

            const kingPiece = Math.floor(Math.random() * state.totalPieces);
            const newState = {
                totalPieces: state.totalPieces,
                kingPiece,
                selections: {},
                started: true,
                revealed: false
            };

            const success = await updateState(newState);
            if (success) {
                state.gameState = newState;
                state.setupComplete = true;
            } else {
                alert('Fehler beim Erstellen');
            }
            state.loading = false;
            render();
        }

        async function resetGame() {
            const success = await updateState({});
            if (success) {
                state.gameState = null;
                state.setupComplete = false;
                state.selectedPiece = null;
                render();
            }
        }

        async function selectPiece(pieceIndex) {
            const input = document.getElementById('name-input');
            const userName = input?.value.trim();
            
            if (!userName) {
                alert('Bitte gib deinen Namen ein!');
                return;
            }

            const existingSelection = Object.values(state.gameState.selections).find(
                sel => sel.name.toLowerCase() === userName.toLowerCase()
            );

            if (existingSelection) {
                alert('Dieser Name hat bereits ein Br√∂tchen gew√§hlt!');
                return;
            }

            const newState = { ...state.gameState };
            newState.selections[pieceIndex] = {
                name: userName,
                timestamp: Date.now()
            };

            const success = await updateState(newState);
            if (success) {
                state.selectedPiece = null;
                await fetchState();
            } else {
                alert('Fehler beim Speichern');
            }
        }

        async function revealAll() {
            const newState = { ...state.gameState, revealed: true };
            await updateState(newState);
            await fetchState();
        }

        function getContent(index) {
            if (state.gameState?.kingPiece === index) {
                return KING_TASK;
            }
            return DISCUSSION_PROMPTS[index % DISCUSSION_PROMPTS.length];
        }

        function openPieceModal(index) {
            state.selectedPiece = index;
            render();
            // Focus input after render
            setTimeout(() => {
                document.getElementById('name-input')?.focus();
            }, 100);
        }

        function closeModal() {
            state.selectedPiece = null;
            render();
        }

        // Render
        function render() {
            const app = document.getElementById('app');

            if (state.loading) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center">
                        <div class="text-center">
                            <i data-lucide="refresh-cw" class="w-8 h-8 text-amber-600 mx-auto mb-4 animate-spin"></i>
                            <p class="text-gray-600">Verbinde mit Supabase...</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            if (!state.connected) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center p-4">
                        <div class="bg‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã
