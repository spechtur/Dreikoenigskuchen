<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digitaler Dreik√∂nigskuchen - PHGR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        const SUPABASE_URL = 'https://hazjcbrsozvgfuyxsugn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhempjYnJzb3p2Z2Z1eXhzdWduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyNTI1MjAsImV4cCI6MjA4MjgyODUyMH0.5L1FbkUC04Jdx6Syx1iI4wfUKDeA6H1wqLRf1xawgzY';

        const DISCUSSION_PROMPTS = [
            "Wie k√∂nnen wir als Schulleitung eine Kultur schaffen, in der Digitalit√§t nicht als Bedrohung, sondern als Chance verstanden wird?",
            "Welche konkreten Schritte braucht es, damit Lehrpersonen digitale Werkzeuge nicht nur nutzen, sondern auch deren p√§dagogischen Mehrwert verstehen?",
            "Wie unterscheiden wir in der Schulf√ºhrung zwischen sinnvoller digitaler Innovation und kurzlebigen technologischen Modeerscheinungen?",
            "Welche Kompetenzen ben√∂tigen Sch√ºler*innen wirklich, um in einer digitalisierten Welt selbstbestimmt handeln zu k√∂nnen?",
            "Wie gehen wir als Schule damit um, dass KI viele traditionelle Aufgabenformate ver√§ndert oder √ºberfl√ºssig macht?",
            "Welche Rolle spielt Datenschutz in unserer Schule - und wie kommunizieren wir das transparent gegen√ºber Eltern?",
            "Wie k√∂nnen wir Unterricht so gestalten, dass er auch dann wertvoll bleibt, wenn KI vieles schneller erledigen kann?",
            "Was bedeutet es konkret, wenn wir von 'Lernen in einer Kultur der Digitalit√§t' sprechen - nicht nur √ºber Digitalit√§t?",
            "Wie schaffen wir als Schulleitung R√§ume f√ºr Experimente mit neuen Lernformen, ohne dabei die Orientierung zu verlieren?",
            "Welche √Ñngste und Widerst√§nde bei Lehrpersonen bez√ºglich KI sind berechtigt - und welche k√∂nnen wir durch Information aufl√∂sen?",
            "Wie bringen wir in der Schulentwicklung technische M√∂glichkeiten und p√§dagogische Ziele zusammen?",
            "Welche neuen Formen der Leistungsbeurteilung brauchen wir, wenn KI viele bisherige Pr√ºfungsformate fragw√ºrdig macht?",
            "Wie k√∂nnen digitale Tools Inklusion und Chancengerechtigkeit in unserer Schule f√∂rdern?",
            "Welche Aufgaben und T√§tigkeiten im Unterricht werden durch KI tats√§chlich einfacher - und welche komplexer?",
            "Wie entwickeln wir als Schule eine kritische Haltung gegen√ºber digitalen Technologien, ohne innovationsfeindlich zu wirken?",
            "Welche Infrastruktur und Ressourcen ben√∂tigen wir wirklich, um zeitgem√§√üen Unterricht zu erm√∂glichen?",
            "Wie k√∂nnen wir Eltern dabei unterst√ºtzen, den digitalen Wandel in der Schule ihrer Kinder zu verstehen und mitzutragen?",
            "Welche Fortbildungsformate helfen Lehrpersonen am besten, sich in einer digitalisierten Bildungslandschaft weiterzuentwickeln?",
            "Wie schaffen wir Balance zwischen der Vermittlung technischer F√§higkeiten und der F√∂rderung menschlicher Grundkompetenzen?",
            "Welche ethischen Fragen stellen sich, wenn wir KI-Systeme im schulischen Kontext einsetzen?",
            "Wie k√∂nnen wir als Schulleitung Innovation f√∂rdern, ohne einzelne Lehrpersonen zu √ºberfordern?",
            "Welche Unterrichtsformen werden in Zukunft wichtiger - und welche weniger wichtig?",
            "Wie gehen wir mit der Tatsache um, dass Sch√ºler*innen oft digital versierter sind als ihre Lehrpersonen?",
            "Welche Rolle spielen analoge Erfahrungen und haptisches Lernen in einer zunehmend digitalisierten Schule?",
            "Wie k√∂nnen wir Schulentwicklung so gestalten, dass sie partizipativ ist und alle Beteiligten mitnimmt?",
            "Welche Chancen bietet KI f√ºr die Individualisierung des Lernens - und wo liegen die Grenzen?",
            "Wie schaffen wir Transparenz dar√ºber, wann und wie in unserer Schule KI-Systeme zum Einsatz kommen?",
            "Welche Bedeutung hat die physische Begegnung in der Schule, wenn vieles auch digital m√∂glich w√§re?",
            "Wie k√∂nnen wir als Schulleitung eine Fehlerkultur etablieren, die Experimente mit neuen Technologien erm√∂glicht?",
            "Welche Vision haben wir f√ºr unsere Schule in einer digitalisierten Gesellschaft - und wie kommunizieren wir diese?"
        ];

        const KING_TASK = "üëë Du bist heute K√∂nig*in und H√ºter*in der Zeit! Deine k√∂nigliche Aufgabe: Wache dar√ºber, dass Euer Hofstaat rechtzeitig Pausen einlegt und die Mittagszeit geb√ºhrend eingehalten wird. Erinnere die Versammlung mit majest√§tischer G√ºte daran, wenn die Stunde der Erholung naht!";

        let state = {
            connected: false,
            loading: true,
            setupComplete: false,
            totalPieces: 25,
            gameState: null,
            selectedPiece: null,
            pollInterval: null
        };

        async function fetchState() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/kuchen_state?id=eq.current&select=data`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch');

                const data = await response.json();
                if (data[0]?.data && Object.keys(data[0].data).length > 0) {
                    state.gameState = data[0].data;
                    state.setupComplete = data[0].data.started || false;
                }
                state.connected = true;
                render();
            } catch (error) {
                console.error('Error:', error);
                state.connected = false;
                render();
            }
        }

        async function updateState(newState) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/kuchen_state?id=eq.current`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        data: newState,
                        updated_at: new Date().toISOString()
                    })
                });

                if (!response.ok) throw new Error('Failed to update');
                return true;
            } catch (error) {
                console.error('Error:', error);
                return false;
            }
        }

        function startPolling() {
            if (state.pollInterval) clearInterval(state.pollInterval);
            state.pollInterval = setInterval(() => {
                if (state.selectedPiece === null) {
                    fetchState();
                }
            }, 2000);
        }

        function stopPolling() {
            if (state.pollInterval) {
                clearInterval(state.pollInterval);
                state.pollInterval = null;
            }
        }

        async function startGame() {
            state.loading = true;
            render();

            const kingPiece = Math.floor(Math.random() * state.totalPieces);
            const newState = {
                totalPieces: state.totalPieces,
                kingPiece,
                selections: {},
                started: true,
                revealed: false
            };

            const success = await updateState(newState);
            if (success) {
                state.gameState = newState;
                state.setupComplete = true;
            } else {
                alert('Fehler beim Erstellen');
            }
            state.loading = false;
            render();
        }

        async function resetGame() {
            const success = await updateState({});
            if (success) {
                state.gameState = null;
                state.setupComplete = false;
                state.selectedPiece = null;
                render();
            }
        }

        async function selectPiece(pieceIndex) {
            const input = document.getElementById('name-input');
            const userName = input?.value.trim();
            
            if (!userName) {
                alert('Bitte gib deinen Namen ein!');
                return;
            }

            const existingSelection = Object.values(state.gameState.selections).find(
                sel => sel.name.toLowerCase() === userName.toLowerCase()
            );

            if (existingSelection) {
                alert('Dieser Name hat bereits ein Br√∂tchen gew√§hlt!');
                return;
            }

            const newState = { ...state.gameState };
            newState.selections[pieceIndex] = {
                name: userName,
                timestamp: Date.now()
            };

            const success = await updateState(newState);
            if (success) {
                state.selectedPiece = null;
                startPolling();
                await fetchState();
            } else {
                alert('Fehler beim Speichern');
            }
        }

        async function revealAll() {
            const newState = { ...state.gameState, revealed: true };
            await updateState(newState);
            await fetchState();
        }

        function getContent(index) {
            if (state.gameState?.kingPiece === index) {
                return KING_TASK;
            }
            return DISCUSSION_PROMPTS[index % DISCUSSION_PROMPTS.length];
        }

        function openPieceModal(index) {
            state.selectedPiece = index;
            stopPolling();
            render();
            setTimeout(() => {
                document.getElementById('name-input')?.focus();
            }, 100);
        }

        function closeModal() {
            state.selectedPiece = null;
            startPolling();
            render();
        }

        function render() {
            const app = document.getElementById('app');

            if (state.loading) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center">
                        <div class="text-center">
                            <i data-lucide="refresh-cw" class="w-8 h-8 text-amber-600 mx-auto mb-4 animate-spin"></i>
                            <p class="text-gray-600">Verbinde mit Supabase...</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            if (!state.connected) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center p-4">
                        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                            <div class="flex items-center gap-3 mb-6">
                                <i data-lucide="wifi-off" class="w-8 h-8 text-red-600"></i>
                                <h1 class="text-2xl font-bold text-gray-800">Verbindungsfehler</h1>
                            </div>
                            <p class="text-gray-600 mb-4">Konnte keine Verbindung zu Supabase herstellen.</p>
                            <button onclick="window.location.reload()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                                Neu laden
                            </button>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            if (!state.setupComplete) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center p-4">
                        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                            <div class="flex items-center gap-3 mb-6">
                                <i data-lucide="crown" class="w-8 h-8 text-amber-600"></i>
                                <h1 class="text-2xl font-bold text-gray-800">Digitaler Dreik√∂nigskuchen</h1>
                            </div>
                            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-6">
                                <div class="flex gap-2 mb-2">
                                    <i data-lucide="wifi" class="w-5 h-5 text-green-600"></i>
                                    <p class="text-green-800 font-semibold">Multi-User-Modus aktiv</p>
                                </div>
                                <p class="text-green-700 text-sm">Alle Teilnehmenden sehen √Ñnderungen (Auto-Refresh alle 2 Sekunden)</p>
                            </div>
                            <p class="text-gray-600 mb-6">Willkommen zur Weiterbildung "Kultur der Digitalit√§t und KI"! W√§hle die Anzahl Teilnehmende:</p>
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Anzahl Br√∂tchen (5-35)</label>
                                <input type="number" min="5" max="35" value="${state.totalPieces}" 
                                    onchange="state.totalPieces = parseInt(this.value) || 5"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                            </div>
                            <button onclick="startGame()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2">
                                <i data-lucide="play" class="w-5 h-5"></i>
                                Kuchen erstellen
                            </button>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            const totalPieces = state.gameState.totalPieces;
            const pieceRadius = 200;
            const centerSize = 120;
            
            const selectedCount = Object.keys(state.gameState?.selections || {}).length;
            const pieces = Array.from({ length: totalPieces }, (_, i) => {
                const isSelected = state.gameState.selections[i];
                const isKing = state.gameState.kingPiece === i;
                const canSelect = !isSelected && state.selectedPiece === null;
                const isRevealed = state.gameState.revealed;

                const angle = (i / totalPieces) * 2 * Math.PI - Math.PI / 2;
                const x = Math.cos(angle) * pieceRadius;
                const y = Math.sin(angle) * pieceRadius;

                let content = '';
                if (isRevealed && isKing) {
                    content = '<i data-lucide="crown" class="w-8 h-8 text-yellow-400"></i>';
                } else if (isSelected && !isRevealed) {
                    content = `<span class="text-center leading-tight px-1 text-xs text-white">${isSelected.name}</span>`;
                } else if (!isSelected && !isRevealed) {
                    content = `<span class="text-xl">${i + 1}</span>`;
                }

                return `
                    <div onclick="${canSelect ? `openPieceModal(${i})` : ''}"
                        style="position: absolute; left: calc(50% + ${x}px); top: calc(50% + ${y}px); transform: translate(-50%, -50%);"
                        class="w-16 h-16 rounded-full flex items-center justify-center font-bold transition-all duration-300 border-3 shadow-md
                            ${isSelected ? 'bg-amber-600 border-amber-800 scale-90' : 'bg-gradient-to-br from-amber-100 to-amber-200 border-amber-400 hover:scale-110 hover:shadow-lg text-amber-800'}
                            ${!canSelect && !isSelected ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}">
                        ${content}
                    </div>
                `;
            }).join('');

            let resultsHTML = '';
            if (state.gameState?.revealed) {
                const results = Object.entries(state.gameState.selections).map(([pieceIndex, data]) => {
                    const isKing = parseInt(pieceIndex) === state.gameState.kingPiece;
                    return `
                        <div class="p-4 rounded-lg border-2 ${isKing ? 'bg-yellow-50 border-yellow-400' : 'bg-gray-50 border-gray-200'}">
                            <div class="flex items-start gap-3">
                                ${isKing ? '<i data-lucide="crown" class="w-6 h-6 text-yellow-600 flex-shrink-0 mt-1"></i>' : ''}
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800 mb-1">${data.name} ${isKing ? 'üëë' : ''}</div>
                                    <div class="text-sm text-gray-600">${getContent(parseInt(pieceIndex))}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                resultsHTML = `
                    <div class="max-w-4xl mx-auto mt-8">
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                                <i data-lucide="crown" class="w-8 h-8 text-amber-600"></i>
                                Ergebnisse
                            </h2>
                            <div class="space-y-3">${results}</div>
                        </div>
                    </div>
                `;
            }

            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 p-4">
                    <div class="max-w-4xl mx-auto mb-8">
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="crown" class="w-8 h-8 text-amber-600"></i>
                                    <h1 class="text-2xl font-bold text-gray-800">Digitaler Dreik√∂nigskuchen</h1>
                                </div>
                                <button onclick="resetGame()" class="text-sm text-gray-600 hover:text-gray-800 flex items-center gap-2">
                                    <i data-lucide="settings" class="w-4 h-4"></i>
                                    Zur√ºcksetzen
                                </button>
                            </div>
                            <div class="flex items-center gap-4 text-sm text-gray-600">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="wifi" class="w-4 h-4 text-green-600"></i>
                                    <span class="text-green-600 font-medium">Synchronisiert</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i data-lucide="users" class="w-4 h-4"></i>
                                    <span>${selectedCount} / ${totalPieces} gew√§hlt</span>
                                </div>
                                ${!state.gameState.revealed && selectedCount > 0 ? `
                                    <button onclick="revealAll()" class="ml-auto bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                        Jetzt aufdecken
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <div class="relative w-full max-w-4xl mx-auto" style="height: 600px;">
                        <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-full bg-amber-200 border-4 border-amber-400 flex items-center justify-center"
                             style="width: ${centerSize}px; height: ${centerSize}px;">
                            <i data-lucide="crown" style="width: ${centerSize * 0.5}px; height: ${centerSize * 0.5}px;" class="text-amber-600"></i>
                        </div>
                        ${pieces}
                    </div>

                    ${state.selectedPiece !== null ? `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Br√∂tchen #${state.selectedPiece + 1}</h2>
                                <p class="text-gray-600 mb-4">Gib deinen Namen ein:</p>
                                <input type="text" id="name-input"
                                    placeholder="Dein Name"
                                    onkeypress="if(event.key === 'Enter') selectPiece(${state.selectedPiece})"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-amber-500">
                                <div class="flex gap-3">
                                    <button onclick="closeModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                                        Abbrechen
                                    </button>
                                    <button onclick="selectPiece(${state.selectedPiece})" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-semibold py-2 px-4 rounded-lg">
                                        W√§hlen
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${resultsHTML}
                </div>
            `;

            lucide.createIcons();
        }

        async function init() {
            await fetchState();
            state.loading = false;
            render();
            startPolling();
        }

        window.startGame = startGame;
        window.resetGame = resetGame;
        window.selectPiece = selectPiece;
        window.revealAll = revealAll;
        window.openPieceModal = openPieceModal;
        window.closeModal = closeModal;
        window.state = state;

        init();
    </script>
</body>
</html>
